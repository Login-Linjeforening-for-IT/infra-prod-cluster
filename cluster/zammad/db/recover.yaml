---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: zammad-recovery
  namespace: zammad
spec:
  imageName: ghcr.io/cloudnative-pg/postgresql:16.4
  monitoring:
    enablePodMonitor: true
  description: Recovery for zammad
  instances: 3
  primaryUpdateStrategy: unsupervised
  storage:
    size: 35Gi
  postgresql:
    parameters:
      timezone: "Europe/Oslo"
      max_connections: "250"
      superuser_reserved_connections: "10"
      max_wal_senders: "20"
      max_replication_slots: "10"
  superuserSecret:
    name: zammad-db-credentials
  bootstrap:
    recovery:
      backup:
        name: zammad-psql-backup-20241105000000
      recoveryTarget:
        targetTime: 2024-11-05 20:00:00.000000+02
  backup:
    retentionPolicy: "30d"
    barmanObjectStore:
      destinationPath: s3://login-infra-prod-psql-backups/zammad
      s3Credentials:
        accessKeyId:
          name: zammad-pg-backup
          key: access
        secretAccessKey:
          name: zammad-pg-backup
          key: secret
