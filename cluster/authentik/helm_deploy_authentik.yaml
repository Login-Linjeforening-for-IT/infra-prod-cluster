---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: authentik
  namespace: authentik
spec:
  interval: 5m
  chart:
    spec:
      chart: authentik
      version: "2023.10.3"
      sourceRef:
        kind: HelmRepository
        name: authentik-repo
        namespace: authentik
      interval: 1m
  values:
    authentik:
      secret_key: "PleaseGenerateA50CharKey"
      error_reporting:
        enabled: false
        send_pii: false
      postgresql:
        password: "ThisIsNotASecurePassword"
    blueprints: 
      - authentik-blueprints
    worker:
      volumes:
        - name: authentik-certificate
          projected:
            sources:
            - secret:
                name: authentik-certificate
                items:
                  - key: tls.crt
                    path: authentik_cert.pem
                  - key: tls.key
                    path: authentik_private_key.pem
      volumeMounts:
        - name: authentik-cert
          mountPath: "/certs"
          readOnly: true
    autoscaling:
      server:
        enabled: true
        minReplicas: 1
      worker:
        enabled: true
        minReplicas: 1
    ingress:
      ingressClassName: nginx-ntnu
      annotations:
        nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
        nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
        nginx.ingress.kubernetes.io/upgrade-proxy: "true"
        nginx.ingress.kubernetes.io/enable-websockets: "true"
        nginx.ingress.kubernetes.io/configuration-snippet: |
          more_set_headers X-Forwarded-Proto $scheme;
          more_set_headers X-Forwarded-For $proxy_add_x_forwarded_for;
          more_set_headers Host $host;
          more_set_headers Upgrade $http_upgrade;
      enabled: true
      tls:
        - hosts:
            - authentik.login.no
      hosts:
        - host: authentik.login.no
          paths:
            - path: "/"
              pathType: Prefix
    postgresql:
      enabled: true
      postgresqlPassword: "ThisIsNotASecurePassword"
    redis:
      enabled: true
